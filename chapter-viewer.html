<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Heritage History™ - Digital Book Reader</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
:root{--primary:#4a90e2;--secondary:#50e3c2;--accent:#f5a623;--lab-blue:#080e1c;--page:#fff;--text-on-dark:rgba(255,255,255,.9);--text-on-page:#333;--header-h:60px;--page-w:650px;--page-h:842px;--page-padding:15px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Georgia',serif;background-color:var(--lab-blue);color:var(--text-on-dark);height:100vh;width:100vw;overflow:hidden;display:flex;flex-direction:column;position:fixed;line-height:1.6}
body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;z-index:-2;background-image:radial-gradient(circle at 15% 15%,rgba(249,115,22,.12) 0,transparent 45%),radial-gradient(circle at 85% 85%,rgba(197,83,235,.12) 0,transparent 45%),radial-gradient(circle at 85% 15%,rgba(56,189,248,.05) 0,transparent 40%),radial-gradient(circle at 15% 85%,rgba(251,191,36,.08) 0,transparent 40%);animation:ambient-shift 30s ease infinite alternate}
@keyframes ambient-shift{0%{background-position:0 0,0 0,0 0,0 0}100%{background-position:5% 10%,-5% -5%,10% -5%,-10% 5%}}
@media (prefers-reduced-motion:reduce){body::before{animation:none!important}}
#new-toolbar{position:fixed!important;top:15px!important;right:-60px!important;z-index:9999!important;display:flex!important;flex-direction:column!important;gap:10px!important;transition:right .3s ease,bottom .3s ease,transform .3s ease!important;background:rgba(28,37,54,.9)!important;backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);padding:5px!important;border-radius:8px 0 0 8px!important;box-shadow:-2px 2px 10px rgba(0,0,0,.4)!important;width:58px;border:1px solid rgba(255,255,255,.1)}
#new-toolbar::before{content:"≡";position:absolute;left:-25px;top:50%;transform:translateY(-50%);background:rgba(28,37,54,.9);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);width:25px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:4px 0 0 4px;color:var(--text-on-dark);font-size:20px;box-shadow:-2px 2px 5px rgba(0,0,0,.3);transition:all .3s ease;border:1px solid rgba(255,255,255,.1);border-right:none;cursor:pointer}
.toolbar-trigger-area{position:fixed;top:0;right:0;width:30px;height:100%;z-index:9998;transition:all .3s ease}
#new-toolbar.visible{right:0!important;transform:none!important}
.new-btn{background:rgba(44,62,80,.8)!important;border:1px solid rgba(255,255,255,.15)!important;color:var(--text-on-dark)!important;width:48px!important;height:48px!important;border-radius:4px!important;display:flex!important;align-items:center!important;justify-content:center!important;font-size:25px!important;cursor:pointer!important;transition:all .2s!important;box-shadow:0 2px 5px rgba(0,0,0,.2)!important;user-select:none!important;flex-shrink:0}
.new-btn:hover{background:rgba(52,73,94,.9)!important;border-color:rgba(255,255,255,.25)!important;box-shadow:0 2px 8px rgba(0,0,0,.3)!important;transform:translateY(-2px)!important}
.new-btn:active{transform:translateY(1px)!important}
.new-btn[disabled]{opacity:.5;cursor:not-allowed;pointer-events:none}
.rotated-mode #new-toolbar{top:auto!important;right:50%!important;bottom:-60px!important;transform:translateX(50%)!important;flex-direction:row!important;width:auto!important;height:58px!important;background:rgba(28,37,54,.9)!important;backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);border-radius:8px 8px 0 0!important;padding:5px 10px!important;box-shadow:0 -2px 10px rgba(0,0,0,.4)!important;border:1px solid rgba(255,255,255,.1);border-bottom:none}
.rotated-mode #new-toolbar.visible{bottom:0!important;transform:translateX(50%)!important}
.rotated-mode #new-toolbar::before{left:50%!important;transform:translateX(-50%)!important;top:-25px!important;width:40px!important;height:25px!important;background:rgba(28,37,54,.9);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);border-radius:4px 4px 0 0!important;content:"≡";padding-bottom:5px;color:var(--text-on-dark);border:1px solid rgba(255,255,255,.1);border-bottom:none;cursor:pointer}
.rotated-mode .toolbar-trigger-area{top:auto!important;bottom:0!important;left:0!important;transform:none!important;right:auto!important;width:100%!important;height:30px!important}
.rotated-mode #new-toolbar .new-btn{width:40px!important;height:40px!important;font-size:20px!important;transform: rotate(90deg)}
.rotated-mode .new-btn:hover {transform: rotate(90deg) scale(1.1);background:rgba(52,73,94,.9)!important;border-color:rgba(255,255,255,.25)!important;box-shadow:0 2px 8px rgba(0,0,0,.3)!important}
.rotated-mode .new-btn:active {transform: rotate(90deg) scale(0.95)}
.main-container{flex:1;display:flex;justify-content:center!important;align-items:center!important;padding:0;height:100%;width:100%;overflow:hidden;position:relative;background:transparent}
.book-spread{display:flex;box-shadow:0 10px 35px rgba(0,0,0,.5);position:fixed!important;top:50%!important;left:50%!important;transform-origin:center center;width:auto!important;height:auto!important;transition:transform .3s ease; transform: translate(-50%, -50%)}
.book-page{width:var(--page-w);height:var(--page-h);background-color:var(--page);position:relative;overflow:hidden;flex-shrink:0;display:flex;justify-content:center;align-items:center;border:1px solid rgba(255,255,255,.08);padding:var(--page-padding)}
.book-page.left{border-right:1px solid rgba(255,255,255,.15);border-radius:3px 0 0 3px}
.book-page.right{border-left:1px solid rgba(255,255,255,.15);border-radius:0 3px 3px 0}
.fullscreen-mode:not(.rotated-mode) .book-page.left{border-right:1px solid rgba(255,255,255,.08)!important}
.pdf-canvas{max-width:100%;max-height:100%;display:block;object-fit:contain;box-shadow: none;}
.page-number{display:none}
.page-loading-overlay{position:absolute;inset:var(--page-padding);background:rgba(255,255,255,.6);z-index:50;display:none;justify-content:center;align-items:center;border-radius:3px}
.page-loading-spinner{width:32px;height:32px;border-radius:50%;border:3px solid rgba(0,0,0,.1);border-top-color:var(--primary);animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.page-edge-nav{position:absolute;top:0;height:100%;width:50px;cursor:pointer;z-index:10;transition:background-color .2s;-webkit-tap-highlight-color:transparent}
.page-edge-nav:hover{background-color:rgba(0,0,0,.03)}
.page-edge-left{left:0;border-radius:3px 0 0 3px}
.page-edge-right{right:0;border-radius:0 3px 3px 0}
.page-edge-left:hover::after,.page-edge-right:hover::after{content:"";position:absolute;top:50%;width:12px;height:12px;border-style:solid;border-color:rgba(0,0,0,.6);border-width:2px 2px 0 0;opacity:.8}
.page-edge-left:hover::after{left:18px;transform:translateY(-50%) rotate(-135deg)}
.page-edge-right:hover::after{right:18px;transform:translateY(-50%) rotate(45deg)}
.fullscreen-mode .book-page.right{display:none!important}
.fullscreen-mode .book-page.left{max-width:95vw;max-height:95vh;width:auto;height:auto;border-radius:5px!important;display:flex;justify-content:center;align-items:center;border:1px solid rgba(255,255,255,.08)!important;padding:var(--page-padding)}
.fullscreen-mode .pdf-canvas{max-width:100%;max-height:100%;object-fit:contain}
.rotated-mode .book-page.left{width:var(--page-w)!important;height:var(--page-h)!important;border-radius:0!important;border:none!important;padding:10px!important;background-color:var(--page);display:flex;justify-content:center;align-items:center}
.rotated-mode .book-page.right{display:none!important}
.rotated-mode .pdf-canvas{box-shadow:none;max-width:100%;max-height:100%;object-fit:contain}
body:not(.fullscreen-mode):not(.rotated-mode) .book-page{width:var(--page-w);height:var(--page-h)}
.book-page.right.placeholder-page{background-color:var(--page)!important;border-left:1px solid rgba(0,0,0,.1);position:relative;display:flex!important;justify-content:center;align-items:center}
.book-page.right.placeholder-page::after{content:"End of document";font-size:14px;font-style:italic;color:rgba(0,0,0,.5)}
.book-page.right.placeholder-page .pdf-canvas,.book-page.right.placeholder-page .page-edge-nav,.book-page.right.placeholder-page .page-loading-overlay{display:none}
body:not(.fullscreen-mode):not(.rotated-mode) .book-page.left,
body:not(.fullscreen-mode):not(.rotated-mode) .book-page.right:not(.placeholder-page) {
    position: relative;
    overflow: visible;
}
body:not(.fullscreen-mode):not(.rotated-mode) .book-page.left {
    border-right: none !important;
}
body:not(.fullscreen-mode):not(.rotated-mode) .book-page.right:not(.placeholder-page) {
    border-left: none !important;
}
body:not(.fullscreen-mode):not(.rotated-mode) .book-page.left::after {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 15px;
    height: 100%;
    background: linear-gradient(to left, rgba(0, 0, 0, 0.15), rgba(0, 0, 0, 0));
    pointer-events: none;
    z-index: 5;
    border-radius: 0 2px 2px 0;
}
body:not(.fullscreen-mode):not(.rotated-mode) .book-page.right:not(.placeholder-page)::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 15px;
    height: 100%;
    background: linear-gradient(to right, rgba(0, 0, 0, 0.15), rgba(0, 0, 0, 0));
    pointer-events: none;
    z-index: 5;
    border-radius: 2px 0 0 2px;
}
body:not(.fullscreen-mode):not(.rotated-mode) .book-page.right.placeholder-page {
    border-left: 1px solid rgba(0,0,0,.1) !important;
}
.toc-panel,.upload-modal{position:fixed;z-index:10000;display:none;color:var(--text-on-page)}
.toc-panel{left:50%;top:50%;transform:translate(-50%,-50%);width:90%;max-width:500px;height:80vh;background:#f0f4f8;border-radius:8px;box-shadow:0 5px 25px rgba(0,0,0,.5);flex-direction:column;overflow:hidden}
.toc-panel.visible,.upload-modal.visible,.loading-overlay.visible{display:flex!important}
.toc-header{padding:15px 20px;background:var(--primary);color:#fff;font-weight:700;display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
.toc-header .notes-close{background:none;border:none;color:#fff;font-size:24px;cursor:pointer;padding:0 5px;line-height:1}
.toc-content{flex:1;padding:10px 20px;overflow-y:auto}
.toc-chapter{padding:8px 0;border-bottom:1px solid #d8dfe6}
.toc-chapter-title{font-weight:700;color:var(--primary);cursor:pointer;padding:5px 0}
.toc-chapter-title:hover,.toc-section:hover{color:var(--accent)}
.toc-sections{padding-left:20px;margin-top:5px}
.toc-section{padding:4px 0;cursor:pointer;color:#4a5568;font-size:.95em}
.upload-modal{inset:0;background:rgba(8,14,28,.8);backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);justify-content:center;align-items:center}
.upload-container{background:#f0f4f8;color:var(--text-on-page);padding:30px;border-radius:8px;width:90%;max-width:500px;box-shadow:0 5px 25px rgba(0,0,0,.3)}
.upload-header{font-size:18px;font-weight:700;margin-bottom:20px;color:var(--primary)}
.upload-form{display:flex;flex-direction:column;gap:15px}
.upload-input-group{display:flex;flex-direction:column;gap:5px}
.upload-input-group label{font-size:14px;color:#4a5568}
.upload-input-group input[type=file]{padding:8px;border:1px solid #ccc;border-radius:4px;background:#fff}
.upload-buttons{display:flex;justify-content:flex-end;gap:10px;margin-top:10px}
.upload-btn-cancel,.upload-btn-submit{padding:8px 15px;border-radius:4px;cursor:pointer;font-size:14px}
.upload-btn-cancel{background:#e2e8f0;border:1px solid #cbd5e0;color:#4a5568}
.upload-btn-submit{background:var(--primary);color:#fff;border:none}
.loading-overlay{position:fixed;inset:0;background:rgba(8,14,28,.85);backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);z-index:10001;display:none;justify-content:center;align-items:center;flex-direction:column}
.loading-spinner{width:50px;height:50px;border-radius:50%;border:4px solid rgba(255,255,255,.2);border-top-color:var(--accent);animation:spin 1s linear infinite;margin-bottom:15px}
.loading-message{font-size:16px;color:var(--text-on-dark)}
#status-indicator{display:none}
.page-slider-container{position:fixed;bottom:-80px;left:50%;transform:translateX(-50%);width:90%;max-width:700px;padding:14px 20px;background:rgba(28,37,54,.9);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);border:1px solid rgba(255,255,255,.1);border-bottom:none;box-shadow:0 -4px 20px rgba(0,0,0,.4);display:flex;flex-direction:column;align-items:center;z-index:9998;transition:bottom .35s cubic-bezier(.2,.9,.3,1),transform .35s cubic-bezier(.2,.9,.3,1), left .35s cubic-bezier(.2,.9,.3,1);border-radius:16px 16px 0 0}
.page-slider-container.visible{bottom:0}
.page-slider-track{width:100%;margin-bottom:8px;padding:0 10px}
.page-slider{width:100%;height:6px;-webkit-appearance:none;appearance:none;background:rgba(255,255,255,.1);outline:none;border-radius:3px;overflow:visible;cursor:pointer;transition:height .2s}
.page-slider:hover{height:8px}
.page-slider::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:20px;height:20px;border-radius:50%;background:var(--accent);cursor:pointer;border:3px solid rgba(28,37,54,.9);box-shadow:0 1px 6px rgba(0,0,0,.4);transition:all .2s ease;margin-top:-7px}
.page-slider::-webkit-slider-thumb:hover{width:24px;height:24px;margin-top:-8px}
.page-slider::-webkit-slider-runnable-track{height:100%;background:linear-gradient(to right,var(--accent) var(--slider-percent,0%),rgba(255,255,255,.1) var(--slider-percent,0%));border-radius:3px}
.page-slider::-moz-range-thumb{width:20px;height:20px;border-radius:50%;background:var(--accent);cursor:pointer;border:3px solid rgba(28,37,54,.9);box-shadow:0 1px 6px rgba(0,0,0,.4)}
.page-slider::-moz-range-thumb:hover{width:24px;height:24px}
.page-slider::-moz-range-progress{background-color:var(--accent);height:100%;border-radius:3px}
.page-slider::-moz-range-track{background-color:rgba(255,255,255,.1);height:100%;border-radius:3px}
.page-slider-info{font-size:12px;color:var(--text-on-dark);font-weight:500;letter-spacing:.3px;opacity:.8}
.rotated-mode .page-slider-container{bottom:50%!important;left:-80px!important;top:auto!important;transform:translateY(50%)!important;width:60px!important;height:70vh!important;max-width:none!important;max-height:500px;flex-direction:column-reverse!important;padding:10px 5px!important;background:rgba(28,37,54,.9);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);border:1px solid rgba(255,255,255,.1);border-left:none;border-radius:0 12px 12px 0!important;box-shadow:2px 0 20px rgba(0,0,0,.4)!important}
.rotated-mode .page-slider-container.visible{left:0!important}
.rotated-mode .page-slider-track{width:100%!important;height:100%!important;margin-bottom:0!important;padding:10px 0!important;display:flex;align-items:center;flex:1}
.rotated-mode .page-slider{width:6px!important;height:100%!important;writing-mode:vertical-lr!important;-webkit-appearance:slider-vertical!important;appearance:slider-vertical;margin:0 auto!important;padding:0!important;background:rgba(255,255,255,.1)!important;border-radius:3px}
.rotated-mode .page-slider::-webkit-slider-runnable-track{width:6px!important;height:100%;background:linear-gradient(to top,var(--accent) var(--slider-percent,0%),rgba(255,255,255,.1) var(--slider-percent,0%))!important;border-radius:3px}
.rotated-mode .page-slider::-webkit-slider-thumb{-webkit-appearance: none;appearance: none;width:20px!important;height:20px!important;border-radius: 50%;background: var(--accent);cursor: pointer;border: 3px solid rgba(28,37,54,.9)!important;box-shadow: 0 1px 6px rgba(0,0,0,.4);transition: all .2s ease;margin-top:0!important;margin-left:-7px!important}
.rotated-mode .page-slider:hover::-webkit-slider-thumb {width: 24px !important;height: 24px !important;margin-left: -9px !important}
.rotated-mode .page-slider::-moz-range-thumb{width: 20px;height: 20px;border-radius:50%;background:var(--accent);cursor:pointer;border:3px solid rgba(28,37,54,.9);box-shadow:0 1px 6px rgba(0,0,0,.4);transition: all .2s ease}
.rotated-mode .page-slider:hover::-moz-range-thumb {width: 24px;height: 24px}
.rotated-mode .page-slider::-moz-range-progress{background-color:var(--accent)!important;width:6px!important;border-radius:3px}
.rotated-mode .page-slider::-moz-range-track{background-color:rgba(255,255,255,.1);width:6px!important;border-radius:3px}
.rotated-mode .page-slider-info{transform:rotate(90deg);white-space:nowrap;margin-bottom:15px;padding-top:10px;color:var(--text-on-dark)}
#page-slider-trigger-zone {position: fixed;bottom: 0;left: 0;width: 100%;height: 30px;z-index: 9997;pointer-events: auto}
.rotated-mode #page-slider-trigger-zone {bottom: auto;top: 50%;left: 0;width: 60px;height: 50%}

/* --- START: Dictionary Pop-up Styles --- */
#definition-popup {
    display: none; /* Initially hidden */
    position: absolute;
    z-index: 10002;
    background: white;
    border: 1px solid #ccc;
    border-radius: 5px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    padding: 10px 15px;
    max-width: 300px;
    font-family: sans-serif; /* Use a more readable sans-serif font */
    font-size: 14px;
    color: #333;
    line-height: 1.4;
    transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
    transform: scale(0.95);
    opacity: 0;
    pointer-events: none; /* Initially not interactive */
}

#definition-popup.visible {
    display: block; /* Make it visible */
    transform: scale(1);
    opacity: 1;
    pointer-events: auto; /* Interactive when visible */
}

#close-popup-btn {
    position: absolute;
    top: 3px;
    right: 3px;
    background: none;
    border: none;
    font-size: 18px;
    cursor: pointer;
    color: #888;
    padding: 0 5px;
    line-height: 1;
}
#close-popup-btn:hover {
    color: #333;
}

#popup-word {
    display: block;
    margin-bottom: 5px;
    color: var(--primary); /* Use theme color */
    font-weight: bold;
}

#popup-definition {
    max-height: 150px; /* Limit height and allow scrolling if needed */
    overflow-y: auto;
}

#popup-definition a {
    color: var(--primary);
    text-decoration: none;
}
#popup-definition a:hover {
    text-decoration: underline;
}
#popup-definition i { /* Style for loading text */
    color: #777;
}
#popup-definition span.error-message { /* Style for error text */
     color: #e74c3c; /* Reddish color for errors */
}
/* --- END: Dictionary Pop-up Styles --- */

    </style>
</head>
<body>
    <div id="new-toolbar"></div>
    <div class="toolbar-trigger-area" id="toolbar-trigger-area"></div>
    <div id="status-indicator">Status: Initializing...</div>
    <div class="main-container">
        <div class="book-spread">
            <div class="book-page left"></div>
            <div class="book-page right placeholder-page"></div>
        </div>
    </div>
    <div class="toc-panel" id="toc-panel"></div>
    <div class="upload-modal" id="upload-modal"></div>
    <div class="loading-overlay" id="loading-overlay"></div>
    <div class="page-slider-container" id="page-slider-container"></div>
    <div id="page-slider-trigger-zone"></div>

    <!-- Definition Pop-up -->
    <div id="definition-popup">
        <button id="close-popup-btn">×</button>
        <strong id="popup-word">Word</strong>
        <div id="popup-definition">Loading definition...</div>
    </div>


    <script>
        // Populate Inner HTML directly
        document.getElementById('new-toolbar').innerHTML = `<button class="new-btn" id="upload-btn" title="Upload PDF">📂</button><button class="new-btn" id="single-page-btn" title="Single Page View">☰</button><button class="new-btn" id="double-page-btn" title="Double Page View">◫</button><button class="new-btn" id="rotate-btn" title="Rotate View">📱</button><button class="new-btn" id="toc-btn" title="Table of Contents" disabled>📑</button>`;
        document.querySelector('.book-page.left').innerHTML = `<div class="page-edge-nav page-edge-left"></div><div class="page-edge-nav page-edge-right"></div><canvas id="left-page-canvas" class="pdf-canvas"></canvas><div class="page-number" id="left-page-number"></div><div class="page-loading-overlay"><div class="page-loading-spinner"></div></div>`;
        document.querySelector('.book-page.right').innerHTML = `<div class="page-edge-nav page-edge-left"></div><div class="page-edge-nav page-edge-right"></div><canvas id="right-page-canvas" class="pdf-canvas"></canvas><div class="page-number" id="right-page-number"></div><div class="page-loading-overlay"><div class="page-loading-spinner"></div></div>`;
        document.getElementById('toc-panel').innerHTML = `<div class="toc-header"><span>Table of Contents</span><button class="notes-close" id="close-toc-btn">×</button></div><div class="toc-content"><div id="toc-list">Loading...</div></div>`;
        document.getElementById('upload-modal').innerHTML = `<div class="upload-container"><div class="upload-header">Upload PDF</div><div class="upload-form"><div class="upload-input-group"><label for="pdf-file">Choose PDF File:</label><input type="file" id="pdf-file" accept=".pdf,.PDF"></div><div class="upload-buttons"><button class="upload-btn-cancel" id="cancel-upload-btn">Cancel</button><button class="upload-btn-submit" id="submit-upload-btn">Process File</button></div></div></div>`;
        document.getElementById('loading-overlay').innerHTML = `<div class="loading-spinner"></div><div class="loading-message">Processing PDF document...</div>`;
        document.getElementById('page-slider-container').innerHTML = `<div class="page-slider-track"><input type="range" id="page-slider" class="page-slider" min="1" max="1" value="1" style="--slider-percent: 0%"></div><div class="page-slider-info"><span id="current-page-display">Page 1</span> of <span id="total-pages-display">1</span></div>`;
    </script>
    <script>
        // --- START: Dictionary Lookup Setup ---
        const DICTIONARY_API_KEY = "d32d5d04-e97d-45b9-b5d8-e32979723097"; // <-- Your Intermediate Dictionary Key
        const definitionPopup = document.getElementById('definition-popup');
        const popupWord = document.getElementById('popup-word');
        const popupDefinition = document.getElementById('popup-definition');
        const closePopupBtn = document.getElementById('close-popup-btn');
        let currentViewports = {}; // Store viewports used for rendering
        // --- END: Dictionary Lookup Setup ---

        pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        const book={title:"No Document",author:"Unknown",totalPages:0,currentPage:1,isDoublePageView:true,pdfDocument:null,outline:[]}; // Default to true, will be set based on width
        const user={readingProgress:{furthestPage:1}};
        let toolbarTimer=null;
        let toolbarHover=!1;
        const pageCache=new Map();
        const MAX_CACHE_SIZE=15;
        let PAGE_PADDING=15;
        let resizeTimer;
        let sliderHideTimeout=null;
        const updateStatus=m=>console.log("Status:",m); // Keep console logs for debugging
        function manageToolbar(s=null){const t=document.getElementById('new-toolbar');if(!t)return;clearTimeout(toolbarTimer);const show=s??toolbarHover;if(show){t.classList.add('visible')}else{toolbarTimer=setTimeout(()=>{!toolbarHover&&t.classList.remove('visible')},500)}}
        function setupToolbarHover(){const t=document.getElementById('new-toolbar'),a=document.getElementById('toolbar-trigger-area'),h=t;if(!t||!a){console.error("Toolbar or trigger area not found");return}const enter=()=>{toolbarHover=!0;manageToolbar(!0)};const leave=()=>{toolbarHover=!1;manageToolbar(!1)};a.addEventListener('mouseenter',enter);t.addEventListener('mouseenter',enter);a.addEventListener('mouseleave',leave);t.addEventListener('mouseleave',leave);h.addEventListener('click',e=>{if(e.target.closest('.new-btn'))return;const r=h.getBoundingClientRect(),i=document.body.classList.contains('rotated-mode');let c=!1;const w=25,rh=25;if(i){if(e.clientX>=r.left&&e.clientX<=r.right&&e.clientY<r.top&&e.clientY>=r.top-rh)c=!0}else{if(e.clientY>=r.top&&e.clientY<=r.bottom&&e.clientX<r.left&&e.clientX>=r.left-w)c=!0}if(c){toolbarHover=!t.classList.contains('visible');manageToolbar()}});updateStatus("Toolbar hover/click setup complete")}
        function trimCache(){while(pageCache.size>MAX_CACHE_SIZE){const k=pageCache.keys().next().value;pageCache.delete(k);updateStatus(`Removed page ${k} from cache`)}}
        function showPageLoading(cId){const c=document.getElementById(cId),l=c?.parentElement?.querySelector('.page-loading-overlay');l&&(l.style.display='flex')}
        function hidePageLoading(cId){const c=document.getElementById(cId),l=c?.parentElement?.querySelector('.page-loading-overlay');l&&(l.style.display='none')}
        async function renderPage(pn,cId){
            const c=document.getElementById(cId),x=c?.getContext('2d'),pEl=c?.parentElement;
            delete currentViewports[cId]; // Clear previous viewport for this canvas

            if(!book.pdfDocument||!c||!x||!pEl||pn<1||pn>book.totalPages){if(c)x.clearRect(0,0,c.width,c.height);hidePageLoading(cId);return}showPageLoading(cId);pEl.classList.remove('placeholder-page');if(pageCache.has(pn)){const d=pageCache.get(pn);c.width=d.width;c.height=d.height;c.style.width=`${d.styleWidth}px`;c.style.height=`${d.styleHeight}px`;x.putImageData(d.imageData,0,0);pageCache.delete(pn);pageCache.set(pn,d);
            currentViewports[cId] = d.viewport; // Restore viewport from cache
            hidePageLoading(cId);updateStatus(`Rendered page ${pn} from cache to ${cId}`);return}try{const p=await book.pdfDocument.getPage(pn);const ps=getComputedStyle(pEl),aw=parseFloat(ps.width)-(2*PAGE_PADDING),ah=parseFloat(ps.height)-(2*PAGE_PADDING);
            if(aw<=0||ah<=0){console.warn(`Canvas container ${cId} has zero/negative dimensions: w=${aw}, h=${ah}. Aborting render.`);hidePageLoading(cId);return}const v=p.getViewport({scale:1});
            const s=Math.min(aw/v.width,ah/v.height);
            const sv=p.getViewport({scale:s});
            currentViewports[cId] = sv; // --- Store viewport ---
            const dpr=window.devicePixelRatio||1;c.width=Math.floor(sv.width*dpr);c.height=Math.floor(sv.height*dpr);c.style.width=`${Math.floor(sv.width)}px`;c.style.height=`${Math.floor(sv.height)}px`;x.scale(dpr,dpr);const rc={canvasContext:x,viewport:sv};await p.render(rc).promise;const iData=x.getImageData(0,0,c.width,c.height);pageCache.set(pn,{imageData:iData,width:c.width,height:c.height,styleWidth:Math.floor(sv.width),styleHeight:Math.floor(sv.height), viewport: sv}); // Store viewport in cache
            trimCache();updateStatus(`Rendered page ${pn} to ${cId} and cached`)}catch(e){console.error(`Error rendering page ${pn}:`,e);updateStatus(`Failed to render page ${pn}`);x.clearRect(0,0,c.width,c.height)}finally{hidePageLoading(cId)}}
        function preloadAdjacentPages(cp){const pToLoad=[];if(book.isDoublePageView){if(cp>2)pToLoad.push(cp-2,cp-1);if(cp+2<=book.totalPages)pToLoad.push(cp+2);if(cp+3<=book.totalPages)pToLoad.push(cp+3)}else{if(cp>1)pToLoad.push(cp-1);if(cp+1<=book.totalPages)pToLoad.push(cp+1)}const uniqueP=[...new Set(pToLoad)].filter(p=>p>0&&p<=book.totalPages&&!pageCache.has(p));if(uniqueP.length===0)return;updateStatus(`Preloading pages: ${uniqueP.join(', ')}`);uniqueP.forEach(pn=>{book.pdfDocument?.getPage(pn).then(p=>{const bw=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--page-w'))||650;const bh=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--page-h'))||842;const aw=bw-(2*PAGE_PADDING);const ah=bh-(2*PAGE_PADDING);const v=p.getViewport({scale:1});const s=Math.min(aw/v.width,ah/v.height);const sv=p.getViewport({scale:s});const tc=document.createElement('canvas');const tx=tc.getContext('2d');const dpr=window.devicePixelRatio||1;tc.width=Math.floor(sv.width*dpr);tc.height=Math.floor(sv.height*dpr);tx.scale(dpr,dpr);p.render({canvasContext:tx,viewport:sv}).promise.then(()=>{const iData=tx.getImageData(0,0,tc.width,tc.height);if(!pageCache.has(pn)){pageCache.set(pn,{imageData:iData,width:tc.width,height:tc.height,styleWidth:Math.floor(sv.width),styleHeight:Math.floor(sv.height), viewport: sv}); // Store viewport in cache
            trimCache();updateStatus(`Preloaded and cached page ${pn}`)}}).catch(re=>console.warn(`Failed preload render page ${pn}: ${re}`))}).catch(pe=>console.warn(`Failed getting page ${pn} for preload: ${pe}`))})}
        async function updateDisplay(){if(!book.pdfDocument){updateStatus("UpdateDisplay: No PDF");const lDiv=document.querySelector('.book-page.left'),rDiv=document.querySelector('.book-page.right'),lC=document.getElementById('left-page-canvas'),rC=document.getElementById('right-page-canvas');lC?.getContext('2d').clearRect(0,0,lC.width,lC.height);rC?.getContext('2d').clearRect(0,0,rC.width,rC.height);lDiv?.style.setProperty('visibility','hidden');rDiv?.classList.add('placeholder-page');rDiv?.style.setProperty('display',book.isDoublePageView?'flex':'none');return}const lpNum=book.currentPage;const rpNum=book.isDoublePageView?book.currentPage+1:0;updateStatus(`Updating display for page(s): ${lpNum}${rpNum>0?', '+rpNum:''}`);const lDiv=document.querySelector('.book-page.left'),rDiv=document.querySelector('.book-page.right'),lNum=document.getElementById('left-page-number'),rNum=document.getElementById('right-page-number');if(!lDiv||!rDiv||!lNum||!rNum){console.error("Critical page elements not found!");return}
        lDiv.style.visibility = 'hidden';rDiv.style.display = 'none';rDiv.classList.remove('placeholder-page');
        if(lpNum>=1&&lpNum<=book.totalPages){lNum.textContent=lpNum;lDiv.style.visibility='visible';await renderPage(lpNum,'left-page-canvas')}else{lNum.textContent='';const lCtx=document.getElementById('left-page-canvas')?.getContext('2d');if(lCtx)lCtx.clearRect(0,0,lCtx.canvas.width,lCtx.canvas.height)}
        if(book.isDoublePageView){if(rpNum>=1&&rpNum<=book.totalPages){rDiv.style.display='flex';rNum.textContent=rpNum;await renderPage(rpNum,'right-page-canvas')} else if (lpNum >= 1 && lpNum <= book.totalPages) {rDiv.style.display='flex';rDiv.classList.add('placeholder-page');rNum.textContent='';const rCtx=document.getElementById('right-page-canvas')?.getContext('2d');if(rCtx) rCtx.clearRect(0,0,rCtx.canvas.width,rCtx.canvas.height)}}
        updateSliderPosition();preloadAdjacentPages(book.currentPage);updateStatus("Display update complete.")}
        function nextPage(){const i=book.isDoublePageView?2:1;const np=book.currentPage+i;if(np<=book.totalPages){jumpToPage(np);showPageSlider();manageToolbar(!1)}}
        function prevPage(){const d=book.isDoublePageView?2:1;const pp=book.currentPage-d;if(pp>=1){jumpToPage(pp);showPageSlider();manageToolbar(!1)}}
        function jumpToPage(pn){if(!book.pdfDocument||pn<1||pn>book.totalPages){updateStatus(`Jump to ${pn} ignored (invalid)`);return}let tp=pn;if(book.isDoublePageView&&tp>1&&tp%2!==1){tp--}if(tp<1) tp=1;if(tp===book.currentPage){updateStatus(`Jump to ${pn} ignored (already on ${tp})`);showPageSlider();return}book.currentPage=tp;updateStatus(`Jumping to page ${tp}`);if(tp>user.readingProgress.furthestPage){user.readingProgress.furthestPage=tp}hideDefinitionPopup(); updateDisplay();showPageSlider();} // Hide popup on page jump
        function setSinglePageView(){if(!book.isDoublePageView&&!document.body.classList.contains('rotated-mode'))return;updateStatus("Setting single page view");book.isDoublePageView=!1;document.body.classList.remove('rotated-mode');document.body.classList.add('fullscreen-mode');document.querySelector('.book-spread').style.transform='translate(-50%, -50%) rotate(0deg) scale(1)';hideDefinitionPopup(); updateDisplay();manageToolbar();updateSliderTotalPages(); updateSliderPosition();}
        function setDoublePageView(){if(book.isDoublePageView&&!document.body.classList.contains('rotated-mode'))return;updateStatus("Setting double page view");book.isDoublePageView=!0;document.body.classList.remove('rotated-mode');document.body.classList.remove('fullscreen-mode');document.querySelector('.book-spread').style.transform='translate(-50%, -50%) rotate(0deg) scale(1)';if(book.currentPage>1&&book.currentPage%2===0){book.currentPage--}hideDefinitionPopup(); updateDisplay();manageToolbar();updateSliderTotalPages(); updateSliderPosition();}
        function setRotatedView(){updateStatus("Setting rotated view");book.isDoublePageView=!1;document.body.classList.remove('fullscreen-mode');document.body.classList.add('rotated-mode');const vpW=window.innerWidth;const vpH=window.innerHeight;const opW=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--page-w'))||650;const opH=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--page-h'))||842;const sX=vpW/opH;const sY=vpH/opW;const s=Math.min(sX,sY)*.95;const sp=document.querySelector('.book-spread');sp.style.transformOrigin='center center';sp.style.transform=`translate(-50%, -50%) rotate(90deg) scale(${s})`;hideDefinitionPopup(); updateDisplay();manageToolbar();updateSliderTotalPages(); updateSliderPosition();}
        function toggleElement(id,show){const el=document.getElementById(id);if(el){el.classList.toggle('visible',show);updateStatus(`${id} visibility set to ${show}`)}else{console.warn(`Element ${id} not found`)}}
        function showUploadModal(){toggleElement('upload-modal',!0);manageToolbar(!1)}
        function hideUploadModal(){toggleElement('upload-modal',!1)}
        function showTableOfContents(){document.getElementById('toc-btn')?.hasAttribute('disabled')||(toggleElement('toc-panel',!0),manageToolbar(!1))}
        function hideTableOfContents(){toggleElement('toc-panel',!1)}
        function showLoading(msg='Processing...'){const lo=document.getElementById('loading-overlay'),lm=lo?.querySelector('.loading-message');if(lo&&lm){lm.textContent=msg;lo.classList.add('visible')}}
        function hideLoading(){toggleElement('loading-overlay',!1)}
        function showPageSlider(){const s=document.getElementById('page-slider-container');if(s&&book.totalPages>0){s.classList.add('visible');resetSliderHideTimer()}else{console.log('showPageSlider ignored')}}
        function hidePageSlider(){const s=document.getElementById('page-slider-container');s&&s.classList.remove('visible')}
        function resetSliderHideTimer(){clearTimeout(sliderHideTimeout);sliderHideTimeout=setTimeout(()=>{hidePageSlider()},3000)}
        function initPageSlider(){const s=document.getElementById('page-slider'),sc=document.getElementById('page-slider-container');if(!s||!sc)return;const inputHandler=()=>{const pn=parseInt(s.value,10);const d=document.getElementById('current-page-display');if(d) { let pt=`Page ${pn}`; if(book.isDoublePageView && pn+1 <= book.totalPages) {pt +=`-${pn+1}`} d.textContent = pt; }; updateSliderStyle(s,pn);resetSliderHideTimer()};const changeHandler=()=>{const pn=parseInt(s.value,10);jumpToPage(pn);resetSliderHideTimer()};s.addEventListener('input',inputHandler);s.addEventListener('change',changeHandler);sc.addEventListener('mouseenter',()=>clearTimeout(sliderHideTimeout));sc.addEventListener('mouseleave',resetSliderHideTimer);updateSliderTotalPages();updateSliderPosition()}
        function updateSliderTotalPages(){const s=document.getElementById('page-slider'),d=document.getElementById('total-pages-display');if(s&&d){const t=book.totalPages>0?book.totalPages:1;s.max=t;d.textContent=t;updateSliderStyle(s,s.value)}}
        function updateSliderPosition(){const s=document.getElementById('page-slider'),d=document.getElementById('current-page-display');if(s&&d){const cp=book.currentPage>0?book.currentPage:1;const tt=book.totalPages>0?book.totalPages:1;s.value=cp;let pt=`Page ${cp}`;if(book.isDoublePageView&&cp+1<=tt){pt+=`-${cp+1}`}d.textContent=pt;updateSliderStyle(s,cp)}}
        function updateSliderStyle(sEl,val){const min=parseInt(sEl.min||1);const max=parseInt(sEl.max||1);const range=(max>min)?(max-min):1;const p=((val-min)/range)*100;sEl.style.setProperty('--slider-percent',`${Math.max(0,Math.min(100,p))}%`)}
        function processUploadedFile(){const fi=document.getElementById('pdf-file');if(!fi||!fi.files||fi.files.length===0){alert("Please select a PDF file first.");return}const f=fi.files[0];updateStatus(`Processing uploaded file: ${f.name}`);hideUploadModal();showLoading(`Loading ${f.name}...`);const r=new FileReader();r.onload=async e=>{if(e.target?.result){const d=new Uint8Array(e.target.result);await loadPdf(d,f.name)}else{console.error("File reading failed");alert("Error reading PDF file.");hideLoading()}};r.onerror=e=>{console.error("File reading error:",e);alert("Error reading PDF file.");hideLoading()};r.readAsArrayBuffer(f)}
        async function loadPdf(source, filename = "Document") {
            updateStatus("loadPdf started");
            showLoading("Initializing PDF...");
            pageCache.clear();
            currentViewports = {}; // Clear stored viewports
            if (book.pdfDocument) {
                try {
                    book.pdfDocument.destroy();
                    updateStatus("Previous PDF cleaned up.");
                } catch (e) {
                    console.warn("Error cleaning up previous PDF:", e);
                }
                book.pdfDocument = null;
            }
            hideDefinitionPopup(); // Hide popup when loading new PDF
            try {
                let loadTask;
                let inferredFilename = filename;
                if (typeof source === 'string') {
                    updateStatus(`Loading PDF from URL: ${source}`);
                    loadTask = pdfjsLib.getDocument(source);
                    if (filename === "Document") {
                        try {
                           const urlParts = source.split('/');
                           inferredFilename = decodeURIComponent(urlParts[urlParts.length - 1]);
                        } catch(e) { /* ignore */ }
                    }
                } else if (source instanceof Uint8Array) {
                    updateStatus(`Loading PDF from data for file: ${filename}`);
                    loadTask = pdfjsLib.getDocument({ data: source });
                    inferredFilename = filename;
                } else {
                    throw new Error("Invalid source type for loadPdf");
                }
                book.pdfDocument = await loadTask.promise;
                book.totalPages = book.pdfDocument.numPages;
                book.currentPage = 1;
                user.readingProgress.furthestPage = 1;
                book.title = inferredFilename.replace(/\.pdf$/i, '');
                updateStatus(`PDF loaded: ${book.title}, Pages: ${book.totalPages}`);
                document.title = `${book.title} - Heritage History™ Reader`;
                updateSliderTotalPages();
                showLoading("Processing metadata...");
                try {
                    book.outline = await book.pdfDocument.getOutline();
                    populateTOC();
                } catch (oe) {
                    console.warn("Could not get PDF outline:", oe);
                    book.outline = [];
                    populateTOC();
                }
                if (window.innerWidth < 1000) {
                    setSinglePageView();
                } else {
                    setDoublePageView();
                }
                requestAnimationFrame(() => {
                    updateStatus("Performing post-load display update via requestAnimationFrame.");
                    updateDisplay();
                });
            } catch (e) {
                console.error("Error loading PDF:", e);
                alert(`Failed to load PDF: ${e.message || e}`);
                book.pdfDocument = null;
                book.totalPages = 0;
                book.currentPage = 1;
                book.title = "No Document";
                book.outline = [];
                document.title = "Heritage History™ - Digital Book Reader";
                updateSliderTotalPages();
                updateSliderPosition();
                populateTOC();
                showUploadModal();
            } finally {
                hideLoading();
            }
        }
        function populateTOC(){const tl=document.getElementById('toc-list'),tb=document.getElementById('toc-btn');if(!tl||!tb)return;tl.innerHTML='';tb.setAttribute('disabled','disabled');if(!book.outline||book.outline.length===0){tl.innerHTML='<em>No table of contents found.</em>';updateStatus("TOC: Not found.");return}tb.removeAttribute('disabled');const createItem=(item,level=0)=>{const d=document.createElement('div');d.className=level===0?'toc-chapter':'toc-section';d.style.marginLeft=`${level*15}px`;const ts=document.createElement('span');ts.className=level===0?'toc-chapter-title':'';ts.textContent=item.title||'Untitled Section';ts.style.cursor='pointer';ts.onclick=async()=>{try{const dest=item.dest;let pi=-1;if(typeof dest==='string'){const nd=await book.pdfDocument.getDestination(dest);if(nd&&typeof nd[0]?.gen==='number'){pi=await book.pdfDocument.getPageIndex(nd[0])}else{throw new Error(`Named dest "${dest}" invalid`)}}else if(Array.isArray(dest)&&typeof dest[0]?.gen==='number'){pi=await book.pdfDocument.getPageIndex(dest[0])}else if(Array.isArray(dest)&&typeof dest[0]==='number'){console.warn("Using potentially deprecated page number dest format.");pi=dest[0]-1}else{console.warn("TOC dest format unrecognized, fallback:",dest);if(item.dest?.[0]?.num){try{pi=await book.pdfDocument.getPageIndex(item.dest[0])}catch{}}if(pi<0)throw new Error('Invalid dest format')}if(pi>=0){const pageNum=pi+1;updateStatus(`TOC Click: Jump to page ${pageNum} for "${item.title}"`);jumpToPage(pageNum);hideTableOfContents()}else{throw new Error('Failed to resolve page index')}}catch(e){console.error('Error handling TOC click:',e);alert(`Could not navigate: ${e.message}`)}};d.appendChild(ts);if(item.items&&item.items.length>0){const sl=document.createElement('div');if(level===0)sl.className='toc-sections';item.items.forEach(si=>{const se=createItem(si,level+1);if(se)sl.appendChild(se)});if(sl.hasChildNodes()){d.appendChild(sl)}}return d};book.outline.forEach(item=>{const ie=createItem(item);if(ie)tl.appendChild(ie)});if(!tl.hasChildNodes()){tl.innerHTML='<em>Error processing TOC.</em>';tb.setAttribute('disabled','disabled');updateStatus("TOC: Error processing items.")}else{updateStatus("TOC populated.")}}
        function setupEvents(){updateStatus("Setting up events");const tbar=document.getElementById('new-toolbar');if(tbar){tbar.addEventListener('click',e=>{const btn=e.target.closest('.new-btn');if(!btn)return;if(btn.hasAttribute('disabled')){e.stopPropagation();return}const id=btn.id;updateStatus(`Toolbar button clicked: ${id}`);switch(id){case'upload-btn':showUploadModal();break;case'single-page-btn':setSinglePageView();break;case'double-page-btn':setDoublePageView();break;case'rotate-btn':setRotatedView();break;case'toc-btn':showTableOfContents();break}resetSliderHideTimer();manageToolbar(!0);toolbarHover=!1;manageToolbar(!1)})}else{console.error("ERROR: Toolbar 'new-toolbar' not found!")}document.getElementById('close-toc-btn')?.addEventListener('click',hideTableOfContents);document.getElementById('cancel-upload-btn')?.addEventListener('click',hideUploadModal);document.getElementById('submit-upload-btn')?.addEventListener('click',processUploadedFile);document.querySelectorAll('.page-edge-nav').forEach(el=>{el.addEventListener('click',e=>{const pp=e.target.closest('.book-page');if(!pp||pp.classList.contains('placeholder-page'))return;const ir=document.body.classList.contains('rotated-mode');const ilp=pp.classList.contains('left');const ice=e.target.classList.contains('page-edge-left');const ispv=!book.isDoublePageView;if(ir){if(ice)prevPage();else nextPage()}else if(ispv){if(ice)prevPage();else nextPage()}else{if(ice&&ilp)prevPage();else if(!ice&&!ilp)nextPage()}})});document.addEventListener('keydown',e=>{if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA'||document.querySelector('.upload-modal.visible')||document.querySelector('.toc-panel.visible') || definitionPopup.classList.contains('visible'))return; // Ignore keydown if popup is visible
        if(e.ctrlKey||e.altKey||e.metaKey)return;let navAct=!1;switch(e.key){case'ArrowRight':case'PageDown':nextPage();navAct=!0;break;case'ArrowLeft':case'PageUp':prevPage();navAct=!0;break;case'Home':if(book.totalPages>0)jumpToPage(1);navAct=!0;break;case'End':if(book.totalPages>0)jumpToPage(book.totalPages);navAct=!0;break; case 'Escape': hideDefinitionPopup(); break; }if(navAct){e.preventDefault();showPageSlider();manageToolbar(!1)}});window.addEventListener('resize',()=>{clearTimeout(resizeTimer);resizeTimer=setTimeout(()=>{updateStatus("Resize detected, updating layout.");hideDefinitionPopup(); if(document.body.classList.contains('rotated-mode')){setRotatedView()}else if(document.body.classList.contains('fullscreen-mode')){setSinglePageView()}else{setDoublePageView()}manageToolbar()},250)});document.querySelector('.main-container').addEventListener('dblclick',e=>{if(e.target===e.currentTarget){if(document.body.classList.contains('rotated-mode'))return;if(document.body.classList.contains('fullscreen-mode')){setDoublePageView()}else{setSinglePageView()}}});let tsX=0,tsY=0,tst=0;const SW_TH=50,SW_TL=500,SW_A=35;document.body.addEventListener('touchstart',e=>{if(e.target.closest('#new-toolbar, .toolbar-trigger-area, #page-slider-container, .upload-modal, .toc-panel, .page-edge-nav, .new-btn, button, input, a, #page-slider-trigger-zone, #definition-popup'))return; // Ignore touch on popup too
        if(e.touches.length===1){tsX=e.touches[0].screenX;tsY=e.touches[0].screenY;tst=Date.now()}else{tsX=0;tsY=0}},{passive:!0});document.body.addEventListener('touchend',e=>{if(e.target.closest('#new-toolbar, .toolbar-trigger-area, #page-slider-container, .upload-modal, .toc-panel, .page-edge-nav, .new-btn, button, input, a, #page-slider-trigger-zone, #definition-popup'))return; // Ignore touch on popup
        if(tsX===0&&tsY===0)return;if(e.changedTouches.length===1){const teX=e.changedTouches[0].screenX;const teY=e.changedTouches[0].screenY;const et=Date.now()-tst;if(et<SW_TL){handleSwipe(tsX,tsY,teX,teY)}}tsX=0;tsY=0;tst=0});function handleSwipe(sx,sy,ex,ey){const dx=ex-sx,dy=ey-sy,adx=Math.abs(dx),ady=Math.abs(dy);if(adx<SW_TH&&ady<SW_TH)return;const angle=Math.atan2(ady,adx)*180/Math.PI;if(angle<=SW_A){if(dx>SW_TH){prevPage()}else if(dx<-SW_TH){nextPage()}showPageSlider();manageToolbar(!1)}}
        const sliderTriggerZone = document.getElementById('page-slider-trigger-zone');const sliderContainer = document.getElementById('page-slider-container');
        if (sliderTriggerZone && sliderContainer) {sliderTriggerZone.addEventListener('mouseenter', () => {if (book.pdfDocument && book.totalPages > 0) {updateStatus("Slider trigger zone hovered, showing slider.");showPageSlider();clearTimeout(sliderHideTimeout);}});sliderTriggerZone.addEventListener('mouseleave', (e) => {if (!sliderContainer.contains(e.relatedTarget)) {updateStatus("Slider trigger zone mouse left (not into slider), starting hide timer.");resetSliderHideTimer();} else {updateStatus("Slider trigger zone mouse left (into slider).");}});sliderContainer.addEventListener('mouseenter', () => {if (sliderContainer.classList.contains('visible')) {updateStatus("Slider container hovered, clearing hide timer.");clearTimeout(sliderHideTimeout);}});sliderContainer.addEventListener('mouseleave', (e) => {if (!sliderTriggerZone.contains(e.relatedTarget)) {updateStatus("Slider container mouse left (not into trigger), starting hide timer.");resetSliderHideTimer();} else {updateStatus("Slider container mouse left (into trigger).");}});} else {console.warn("Page slider trigger zone or container not found.");}

        // --- Dictionary Click Listener Setup ---
        document.querySelector('.main-container').addEventListener('click', handlePdfClick); // Use the instrumented version
        closePopupBtn.addEventListener('click', hideDefinitionPopup);
        document.addEventListener('click', (event) => { // Close popup if clicking outside
            if (definitionPopup.classList.contains('visible') && !definitionPopup.contains(event.target) && !event.target.closest('.book-page')) {
                 hideDefinitionPopup();
            }
        });
        // --- END Dictionary Click Listener Setup ---

        updateStatus("Events setup complete")}

        // --- START: Dictionary Lookup Functions (with combined debugging/error handling) ---

        function hideDefinitionPopup() {
            if (definitionPopup) {
                 definitionPopup.classList.remove('visible');
                 // Reset styles for animation
                 definitionPopup.style.opacity = '0';
                 definitionPopup.style.transform = 'scale(0.95)';
                 definitionPopup.style.pointerEvents = 'none';
            }
        }

        // Updated getDefinition with better error checking
        async function getDefinition(word) {
            if (!DICTIONARY_API_KEY) {
                console.error("Dictionary API Key not set.");
                return { error: "API key not configured." };
            }
            if (!word) {
                return { error: "No word provided." };
            }
            const cleanedWord = word.toLowerCase().replace(/^[^a-z-]+|[^a-z-]+$/g, '').trim();
            if (!cleanedWord) {
                 return { error: "Invalid word characters." };
            }
            const url = `https://www.dictionaryapi.com/api/v3/references/sd2/json/${encodeURIComponent(cleanedWord)}?key=${DICTIONARY_API_KEY}`;

            try {
                console.log(`Fetching definition for: ${cleanedWord} from ${url}`); // Log URL
                const response = await fetch(url);
                console.log(`API Response Status: ${response.status}`); // Log status

                if (!response.ok) {
                    let errorBody = '';
                    try {
                        errorBody = await response.text(); // Read error as text
                        console.log(`API Error Response Body: ${errorBody}`);
                    } catch (textError) {
                        console.warn("Could not read error response body as text:", textError);
                        errorBody = response.statusText;
                    }
                    // Check specifically for "Invalid API key" text if possible
                    if (errorBody.toLowerCase().includes("invalid api key")) {
                         throw new Error(`API request failed: Invalid API Key.`);
                    } else {
                         throw new Error(`API request failed: ${response.status} ${response.statusText}. ${errorBody ? `Details: ${errorBody}` : '(No details)'}`);
                    }
                }

                // Only parse JSON if response is ok
                const data = await response.json();
                console.log(`API response received and parsed for ${cleanedWord}:`, data); // Log parsed data

                if (!Array.isArray(data) || data.length === 0) {
                    return { definition: "Word not found.", suggestions: [] };
                }
                if (typeof data[0] === 'string') {
                     return { definition: `Word not found. Did you mean: ${data.slice(0, 3).join(', ')}?`, suggestions: data };
                }
                if (typeof data[0] === 'object' && data[0] !== null && Array.isArray(data[0].shortdef) && data[0].shortdef.length > 0) {
                    const definitions = data[0].shortdef.map((def, index) => `${index + 1}. ${def}`).join('<br>');
                    return { definition: definitions, suggestions: [] };
                } else {
                     console.warn("Unexpected API response structure or empty shortdef:", data[0]);
                     let fallbackDef = "Definition not found in expected format.";
                     if(data[0]?.def?.[0]?.sseq?.[0]?.[0]?.[1]?.dt?.[0]?.[1]) {
                         try {
                            const firstSense = data[0].def[0].sseq[0][0][1].dt[0][1];
                            if(firstSense && typeof firstSense === 'string') {
                                 fallbackDef = "1. " + firstSense.replace(/{bc}|{it}|{\/it}|{sx\|[^\|]*\|\|}/g, '').replace(/{[^}]*}/g, '').trim();
                            }
                         } catch (parseErr) { console.warn("Failed parsing fallback def:", parseErr)}
                     }
                     return { definition: fallbackDef, suggestions: [] };
                 }

            } catch (error) { // Catches network errors and the 'throw new Error' above
                console.error("Error in getDefinition:", error);
                // Provide more context in the error object
                return { error: `Could not fetch definition. ${ (error.message.includes('API request failed') || error.message.includes('Invalid API Key')) ? 'Please check API configuration.' : 'Network error or invalid response.'} Details: ${error.message}` };
            }
        }


        // Updated handlePdfClick with detailed logging
        async function handlePdfClick(event) {
            console.log("handlePdfClick triggered."); // Log entry

            // Don't trigger on interactive elements or the popup itself
            if (event.target.closest('#new-toolbar, .toolbar-trigger-area, #page-slider-container, .upload-modal, .toc-panel, .page-edge-nav, #definition-popup, button, input, a')) {
                console.log("Click ignored: Target is interactive element or popup.");
                return;
            }

            const clickedElement = event.target;
            let canvasId = null;
            let pageNum = -1;

            if (clickedElement.id === 'left-page-canvas') {
                canvasId = 'left-page-canvas';
                pageNum = book.currentPage;
                console.log(`Click target: ${canvasId}, Page: ${pageNum}`);
            } else if (clickedElement.id === 'right-page-canvas' && book.isDoublePageView && book.currentPage + 1 <= book.totalPages) {
                canvasId = 'right-page-canvas';
                pageNum = book.currentPage + 1;
                 console.log(`Click target: ${canvasId}, Page: ${pageNum}`);
            } else {
                 console.log("Click ignored: Target not a valid page canvas or page invalid.");
                 hideDefinitionPopup(); // Hide if click isn't on a valid canvas
                 return;
            }

             if (!book.pdfDocument || pageNum < 1 || pageNum > book.totalPages) {
                 console.log(`Click ignored: Invalid book state (PDF: ${!!book.pdfDocument}, PageNum: ${pageNum}, Total: ${book.totalPages})`);
                 hideDefinitionPopup();
                 return;
             }

            const canvas = document.getElementById(canvasId);
            if (!canvas) { console.log("Click ignored: Canvas element not found."); hideDefinitionPopup(); return; }
            const rect = canvas.getBoundingClientRect();

            // Calculate click coordinates relative to the canvas element
            const clickX = event.clientX - rect.left;
            const clickY = event.clientY - rect.top;
            console.log(`Canvas Click Coords (element relative): [${clickX.toFixed(2)}, ${clickY.toFixed(2)}]`);

            // Get viewport used for rendering this canvas
            const viewport = currentViewports[canvasId];
            if (!viewport) {
                console.warn("Viewport not found for canvas:", canvasId);
                hideDefinitionPopup();
                return;
            }
            console.log(`Viewport retrieved for ${canvasId}:`, viewport);

            // Convert click coordinates from canvas element space to PDF page space
            const pdfPoint = viewport.convertToPdfPoint(clickX, clickY);
            console.log(`PDF Point Coords: [${pdfPoint[0].toFixed(2)}, ${pdfPoint[1].toFixed(2)}]`);

            try {
                console.log(`Getting page ${pageNum} object...`);
                const page = await book.pdfDocument.getPage(pageNum);
                console.log(`Getting text content for page ${pageNum}...`);
                const textContent = await page.getTextContent({ normalizeWhitespace: true }); // Normalize whitespace
                 console.log("Text content received:", textContent);
                 if (!textContent || !textContent.items || textContent.items.length === 0) {
                      console.warn("Text content is empty or invalid.");
                      hideDefinitionPopup();
                      return;
                 }

                console.log("Calling findWordAtPdfPoint...");
                const foundWordInfo = findWordAtPdfPoint(textContent, pdfPoint, viewport);
                console.log("findWordAtPdfPoint result:", foundWordInfo); // Log the result

                if (foundWordInfo && foundWordInfo.word) {
                    console.log(`Word found: "${foundWordInfo.word}". Preparing popup.`); // Changed from updateStatus
                    const popupX = event.pageX; // Use pageX/pageY for positioning relative to document
                    const popupY = event.pageY;

                    if (definitionPopup && popupWord && popupDefinition) {
                        popupWord.textContent = foundWordInfo.word.charAt(0).toUpperCase() + foundWordInfo.word.slice(1); // Capitalize
                        popupDefinition.innerHTML = '<i>Loading definition...</i>';

                        // Position popup - slightly offset from click
                        definitionPopup.style.left = `${popupX + 15}px`;
                        definitionPopup.style.top = `${popupY + 15}px`;

                        // Make it visible first to calculate dimensions
                        definitionPopup.style.display = 'block';
                        definitionPopup.style.opacity = '0';
                        definitionPopup.style.transform = 'scale(0.95)';

                        // Adjust position if it goes off-screen
                        setTimeout(() => {
                            const popupRect = definitionPopup.getBoundingClientRect();
                            let finalLeft = popupX + 15;
                            let finalTop = popupY + 15;

                            if (finalLeft + popupRect.width > window.innerWidth - 10) { // Check right edge
                                finalLeft = popupX - popupRect.width - 15; // Place to the left
                            }
                            if (finalTop + popupRect.height > window.innerHeight - 10) { // Check bottom edge
                                finalTop = popupY - popupRect.height - 15; // Place above
                            }
                             if (finalLeft < 10) { // Check left edge
                                 finalLeft = 10;
                             }
                             if (finalTop < 10) { // Check top edge
                                  finalTop = 10;
                             }
                            definitionPopup.style.left = `${finalLeft}px`;
                            definitionPopup.style.top = `${finalTop}px`;

                            // Fade in
                            definitionPopup.classList.add('visible'); // Add class AFTER setting position
                        }, 0);


                        // Fetch and display definition
                        console.log(`Calling getDefinition for "${foundWordInfo.word}"...`); // Log before API call
                        const result = await getDefinition(foundWordInfo.word);
                         console.log("getDefinition result:", result); // Log API result
                        if (result.error) {
                             console.error("Error received from getDefinition:", result.error); // Log the specific error
                            popupDefinition.innerHTML = `<span class="error-message">Error: ${result.error}</span><br><a href="https://www.google.com/search?q=${encodeURIComponent(foundWordInfo.word)}+definition" target="_blank" rel="noopener noreferrer">Search Google for "${foundWordInfo.word}"?</a>`;
                        } else {
                            popupDefinition.innerHTML = result.definition;
                             if(result.definition.includes("not found") || result.definition.includes("Did you mean")) {
                                 popupDefinition.innerHTML += `<br><a href="https://www.google.com/search?q=${encodeURIComponent(foundWordInfo.word)}+definition" target="_blank" rel="noopener noreferrer">Search Google for "${foundWordInfo.word}"?</a>`;
                             }
                        }
                    } else {
                         console.error("Popup elements not found!");
                    }
                } else {
                    console.log("No word found at click location by findWordAtPdfPoint.");
                    hideDefinitionPopup();
                }
            } catch (error) {
                console.error("Error during PDF click processing:", error);
                hideDefinitionPopup();
            }
        }


        function findWordAtPdfPoint(textContent, pdfPoint, viewport) {
             // ...(findWordAtPdfPoint logic remains the same as the previous version)...
             let clickedItem = null;
             const clickX = pdfPoint[0];
             const clickY = pdfPoint[1];

             // Find text item containing the point
             for (const item of textContent.items) {
                 if (!item.str.trim()) continue;

                 // item.transform is the PDF matrix [scaleX, skewY, skewX, scaleY, tx, ty]
                 // Bounding box calculation in PDF coordinates
                 // Transform points [0,0] and [width, height] using the item's matrix
                 const itemMatrix = item.transform;
                 const width = item.width;
                 const height = item.height; // Often represents font ascent

                 // Calculate bbox corners in PDF space
                 const p1 = pdfjsLib.Util.applyTransform([0, 0], itemMatrix);       // Bottom-left?
                 const p2 = pdfjsLib.Util.applyTransform([width, 0], itemMatrix);   // Bottom-right?
                 const p3 = pdfjsLib.Util.applyTransform([0, height], itemMatrix);  // Top-left?
                 const p4 = pdfjsLib.Util.applyTransform([width, height], itemMatrix); // Top-right?

                 const itemRect = {
                      left: Math.min(p1[0], p2[0], p3[0], p4[0]),
                      right: Math.max(p1[0], p2[0], p3[0], p4[0]),
                      bottom: Math.min(p1[1], p2[1], p3[1], p4[1]), // PDF Y increases upwards
                      top: Math.max(p1[1], p2[1], p3[1], p4[1]),
                 };

                 // Add a small tolerance for clicking near edges
                 const tolerance = 1; // PDF units tolerance
                 if (clickX >= itemRect.left - tolerance && clickX <= itemRect.right + tolerance &&
                     clickY >= itemRect.bottom - tolerance && clickY <= itemRect.top + tolerance) {
                       clickedItem = item;
                       break; // Assume first found item is good enough for now
                 }
             }

             if (!clickedItem) {
                 console.log("findWordAtPdfPoint: No text item found at PDF point."); // Debug log
                 return null;
             }
              console.log("findWordAtPdfPoint: Found initial text item:", clickedItem); // Debug log

             // Reconstruct word (similar logic as before, but using PDF coordinates)
             const lineTolerance = clickedItem.height * 0.5; // Tolerance for items on the same line
             const clickedItemOriginY = clickedItem.transform[5]; // Y-translation (origin)

             let lineItems = textContent.items.filter(itm => {
                  // Ensure item has transform and height before comparing
                  return itm.transform && typeof itm.height === 'number' && Math.abs(itm.transform[5] - clickedItemOriginY) < lineTolerance;
              }).sort((a, b) => {
                  // Ensure items have transform before sorting
                   return (a.transform ? a.transform[4] : 0) - (b.transform ? b.transform[4] : 0); // Sort by X-translation (origin)
              });
             console.log(`findWordAtPdfPoint: Found ${lineItems.length} items potentially on the same line.`); // Debug log

             let word = "";
             let startIndex = -1, endIndex = -1;
             const clickedItemIndex = lineItems.findIndex(itm => itm === clickedItem);

             if (clickedItemIndex === -1) {
                 console.warn("findWordAtPdfPoint: Clicked item not found in sorted line items."); // Debug log
                 return null;
             }

             // Find word start (go left)
             for (let i = clickedItemIndex; i >= 0; i--) {
                  const currentItem = lineItems[i];
                  const currentStr = currentItem.str;
                  if (!currentStr) continue; // Skip if string is empty

                  // Check gap to previous item
                  let isSpaceBefore = false;
                  if (i > 0) {
                      const prevItem = lineItems[i-1];
                       // Ensure items have necessary properties
                       if (prevItem.transform && typeof prevItem.width === 'number' && currentItem.transform) {
                           const prevRight = prevItem.transform[4] + prevItem.width;
                           const currentLeft = currentItem.transform[4];
                           // Heuristic: Gap larger than ~1/3 average char width suggests space
                           const avgCharWidth = (clickedItem.width / (clickedItem.str?.length || 1)) || 5; // Provide default if length is 0
                           if (currentLeft - prevRight > avgCharWidth * 0.3) {
                               isSpaceBefore = true;
                           }
                       }
                  }

                   // Check for explicit space at start or inferred space before
                  if (currentStr.startsWith(' ') || currentStr.startsWith('\t') || currentStr.startsWith('\n') || isSpaceBefore) {
                      startIndex = i + 1; // Word starts *after* the space or the item with space before it
                      break;
                  }

                  startIndex = i; // Include this item as potential start

                  // If the item itself contains a space, the word likely started within it or just after the space
                  if (currentStr.includes(' ') || currentStr.includes('\t') || currentStr.includes('\n')) {
                      const parts = currentStr.split(/(\s+)/);
                      if (parts.length > 1 && parts[parts.length-1] && !/^\s+$/.test(parts[parts.length-1])) {
                          // If non-space part is at the end, this item is the start
                      } else {
                          // Space is at the end, or only space
                          startIndex = i+1; // Word starts after this item
                      }
                      break; // Found boundary
                  }
             }
              if (startIndex < 0) startIndex = 0;
              console.log(`findWordAtPdfPoint: Determined start index: ${startIndex}`); // Debug log


             // Find word end (go right)
             for (let i = clickedItemIndex; i < lineItems.length; i++) {
                 const currentItem = lineItems[i];
                 const currentStr = currentItem.str;
                 if (!currentStr) continue; // Skip if string is empty

                 let isSpaceAfter = currentStr.endsWith(' ') || currentStr.endsWith('\t') || currentStr.endsWith('\n');
                  if (!isSpaceAfter && i + 1 < lineItems.length) {
                      const nextItem = lineItems[i+1];
                       // Ensure items have necessary properties
                       if(currentItem.transform && typeof currentItem.width === 'number' && nextItem.transform) {
                           const currentRight = currentItem.transform[4] + currentItem.width;
                           const nextLeft = nextItem.transform[4];
                           const avgCharWidth = (clickedItem.width / (clickedItem.str?.length || 1)) || 5;
                           if (nextLeft - currentRight > avgCharWidth * 0.3) {
                               isSpaceAfter = true;
                           }
                       }
                  }
                  endIndex = i; // Include this item
                  if (isSpaceAfter) {
                      break; // Word ends with this item
                  }
             }
              if (endIndex < 0) endIndex = lineItems.length - 1;
              console.log(`findWordAtPdfPoint: Determined end index: ${endIndex}`); // Debug log


             // Assemble the word
             for (let i = startIndex; i <= endIndex; i++) {
                  if (lineItems[i] && lineItems[i].str) { // Check item exists
                      word += lineItems[i].str;
                  }
             }
              console.log(`findWordAtPdfPoint: Assembled word before cleaning: "${word}"`); // Debug log


             // Final cleaning
             const cleanedWord = word
                 .replace(/\s+/g, '') // Remove internal spaces from reconstruction glitches
                 .replace(/^[^\p{L}\p{N}-]+|[^\p{L}\p{N}-]+$/gu, '') // Remove leading/trailing punctuation/symbols (keep internal hyphens)
                 .trim();
             console.log(`findWordAtPdfPoint: Cleaned word: "${cleanedWord}"`); // Debug log


             if (!cleanedWord || cleanedWord.length < 2) {
                 console.log("findWordAtPdfPoint: Cleaned word too short or empty."); // Debug log
                 return null; // Ignore single chars or empty strings
             }

             return { word: cleanedWord };
        }
        // --- END: Dictionary Lookup Functions ---

        async function init() {
            updateStatus("Initializing app");
            try {
                try {
                    PAGE_PADDING = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--page-padding')) || 15;
                } catch (ce) {
                    console.warn("Could not read --page-padding CSS, using 15px.", ce);
                    PAGE_PADDING = 15;
                }
                updateStatus(`Page padding: ${PAGE_PADDING}px`);
                setupEvents();
                setupToolbarHover();
                initPageSlider();
                hideLoading();

                const urlParams = new URLSearchParams(window.location.search);
                const pdfUrlParam = urlParams.get('pdf');

                if (pdfUrlParam) {
                    updateStatus(`Found PDF parameter in URL: ${pdfUrlParam}`);
                    await loadPdf(pdfUrlParam);
                } else {
                    updateStatus("No PDF specified in URL, showing upload modal.");
                    const lDiv=document.querySelector('.book-page.left'),rDiv=document.querySelector('.book-page.right');
                    lDiv?.style.setProperty('visibility','hidden');
                    rDiv?.classList.add('placeholder-page');
                    rDiv?.style.setProperty('display', book.isDoublePageView ? 'flex' : 'none');
                    showUploadModal();
                }

                window.addEventListener('beforeunload', () => {
                    pageCache.clear();
                    currentViewports = {};
                    if (book.pdfDocument) {
                        try {
                            book.pdfDocument.destroy();
                        } catch (e) { console.warn("Error destroying PDF on unload", e); }
                    }
                });
                updateStatus("Init complete.");

            } catch (e) {
                console.error("Init failed:", e);
                document.body.innerHTML = `<div style="padding:20px;color:#fdd;background:#300;font-family:sans-serif;"><h2>Init Error</h2><p>Could not start. Check console (F12).</p><pre>${e.stack || e}</pre></div>`;
            }
        }
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
